{% extends 'index.html' %}
{% load static %}

{% block Title %} Team {{ team_number }}{% endblock %}

{% block Content %}
<h2>Team {{ team_number }}</h2>
<input type="hidden" id="team_number" value="{{ team_number }}">

{% if team.pit_scout_status == True %}
<div class="row">
    <div class="col-8">
        <span><b>Drivetrain: </b>{{ team.drivetrain }}</span> <br> <br>
        <span><b>Length x Width (Bumper): </b>{{ team.length }} x {{ team.width }}</span> <br> <br>
        <span><b>Weight: </b>{{ team.weight }}</span> <br> <br>
        <span><b>Intake Design: </b>{{ team.intake_design }}</span> <br> <br>
        <span><b>Under Shallow: </b>{{ team.under_shallow }}</span> <br> <br>
        <span><b>Ball Remover?: </b>{{ team.algae_picker }}</span> <br> <br>
        <span><b>Intake Locations: </b>{{ team.intake_locations }}</span> <br> <br>
        <span><b>Scoring Locations: </b>{{ team.scoring_locations }}</span> <br> <br>
        <span><b>Cage Positions: </b>{{ team.cage_positions }}</span> <br> <br>
        <span><b>Auto Positions: </b>{{ team.auto_positions }}</span> <br> <br>
        <span><b>Auto Leave: </b>{{ team.auto_leave }}</span> <br> <br>
        <span><b>Auto Algae Max: </b>{{ team.auto_algae_max }}</span> <br> <br>
        <span><b>Auto Coral Max: </b>{{ team.auto_coral_max }}</span> <br> <br>
        <span><b>Additional Info: </b> {{ team.additional_info }}</span> <br> <br>
        <a href="{% url 'pit_scouting' team_number %}?comp={{ request.GET.comp }}">Update Info</a>
    </div>
    <div class="col-4">
        {% if team.robot_picture %}
        <img src="{{ team.robot_picture }}" alt="Robot Picture" class="img-thumbnail">
        {% else %}
        <p>No robot picture available.</p>
        {% endif %}
    </div>
</div>
{% else %}
<a href="{% url 'pit_scouting' team_number %}?comp={{ comp_code }}">Pit Scout</a>
{% endif %}

<!-- Match Data Table -->
<div class="table-responsive">
    <button id="toggleComments" class="btn btn-sm btn-secondary mb-2">Show All Comments</button>
    <table id="match_data" class="table table-bordered">
        <thead>
            <tr>
                <th>Match</th>
                <th>Leave</th>
                <th>A-L1</th>
                <th>A-L2</th>
                <th>A-L3</th>
                <th>A-L4</th>
                <th>A-Net</th>
                <th>A-Proc</th>
                <th>A-Rem</th>
                <th>T-L1</th>
                <th>T-L2</th>
                <th>T-L3</th>
                <th>T-L4</th>
                <th>T-Net</th>
                <th>T-Proc</th>
                <th>T-Rem</th>
                <th>Climb</th>
                <th>Driver</th>
                <th>Defense</th>
                <th>Start Position</th>
                <th>Missed-Auto</th>
                <th>Auto Path</th>
                <th id="comments_column">Comments</th>
                <th>Scout Name</th>
            </tr>
        </thead>
        <tbody>
            {% for match in all_team_match_data %}
            <tr>
                <td>{{ match.match_number }}{% if match.quantifier %}-{{ match.quantifier }}{% endif %}</td>
                <td>{{ match.auto_leave }}</td>
                <td>{{ match.auto_L1 }}</td>
                <td>{{ match.auto_L2 }}</td>
                <td>{{ match.auto_L3 }}</td>
                <td>{{ match.auto_L4 }}</td>
                <td>{{ match.auto_net }}</td>
                <td>{{ match.auto_processor }}</td>
                <td>{{ match.auto_removed }}</td>
                <td>{{ match.teleL1 }}</td>
                <td>{{ match.teleL2 }}</td>
                <td>{{ match.teleL3 }}</td>
                <td>{{ match.teleL4 }}</td>
                <td>{{ match.telenet }}</td>
                <td>{{ match.teleProcessor }}</td>
                <td>{{ match.teleRemoved }}</td>
                <td>{{ match.climb }}</td>
                <td>{{ match.driver_ranking }}</td>
                <td>{{ match.defense_ranking }}</td>
                <td>{{ match.start_pos }}</td>
                <td>{{ match.missed_auto }}</td>
                <td>
                    {% if match.auto_path %}
                        <a href="#" class="auto-path-link" data-match="{{ match.match_number }}" 
                           data-quantifier="{{ match.quantifier }}" data-scout="{{ match.scout_name }}">
                            View Path
                        </a>
                        <div class="auto-path-popup" style="display: none;">
                            {{ match.auto_path }}
                        </div>
                    {% endif %}
                </td>
                <td>
                    {% if match.comment %}
                    <a href="#" class="comment-link" data-comment="{{ match.comment }}">
                        View Comment
                    </a>
                    <span class="full-comment" style="display: none;">{{ match.comment }}</span>
                    {% endif %}
                </td>
                <td>{{ match.scout_name }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="23" class="text-center">No match data available</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Replay System Section -->
<h3>Auto Path Replay</h3>
<div class="replay-container">
    <select id="pathSelector" class="form-control mb-2">
        <option value="">Select a match to replay</option>
        {% for match in all_team_match_data %}
            {% if match.auto_path %}
                <option value="{{ match.match_number }}" data-scout="{{ match.scout_name }}">
                    Match {{ match.match_number }}
                    {% if match.quantifier %}-{{ match.quantifier }}{% endif %}
                    {% if match.scout_name %} (Scout: {{ match.scout_name }}){% endif %}
                </option>
            {% endif %}
        {% endfor %}
    </select>

    <div class="d-flex">
        <div class="replay-canvas-container">
            <img src="{% static 'images/replays.png' %}" alt="Auto Map" style="width: 100%; max-width: 800px;">
            <canvas id="replayCanvas" style="position: absolute; top: 0; left: 0; width: 100%; max-width: 800px; height: auto;"></canvas>
        </div>
        <div class="path-info ms-3">
            <p>Position: <span id="currentPosition">0</span> / <span id="totalPositions">0</span></p>
        </div>
    </div>

    <div class="controls mt-2">
        <button id="backButton" class="btn btn-secondary">Back</button>
        <button id="playButton" class="btn btn-primary">Play</button>
        <button id="pauseButton" class="btn btn-secondary">Pause</button>
        <button id="forwardButton" class="btn btn-secondary">Forward</button>
        <button id="resetButton" class="btn btn-warning">Reset</button>
    </div>
</div>

<!-- Include the external JavaScript file -->
<script src="{% static 'team/replay_system.js' %}"></script>

<style>
    /* Table Styles */
    #match_data thead th {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        background: white;
        z-index: 10;
        box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
        max-height: 600px;
        overflow: auto;
    }

    /* Popup Styles */
    .auto-path-link, .comment-link {
        color: #007bff;
        text-decoration: none;
        cursor: pointer;
    }
    
    .auto-path-link:hover, .comment-link:hover {
        text-decoration: underline;
    }
    
    .auto-path-popup, .comment-popup {
        position: absolute;
        background: white;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        max-width: 400px;
        word-wrap: break-word;
    }

    /* Replay System Styles */
    .replay-container {
        max-width: 800px;
        margin: 0 auto;
    }
    
    .replay-canvas-container {
        position: relative;
        flex: 1;
    }
    
    .path-info {
        width: 150px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .controls {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 10px;
    }
    
    #toggleComments {
        position: sticky;
        left: 20px;
        z-index: 20;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentPopup = null;

    // Auto Path Popups
    document.querySelectorAll('.auto-path-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            closePopups();
            
            const popup = this.nextElementSibling.cloneNode(true);
            popup.style.display = 'block';
            popup.className = 'auto-path-popup';
            
            const rect = this.getBoundingClientRect();
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${rect.left}px`;
            
            document.body.appendChild(popup);
            currentPopup = popup;
        });
    });

    // Comment Popups
    document.querySelectorAll('.comment-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            closePopups();
            
            const popup = document.createElement('div');
            popup.className = 'comment-popup';
            popup.textContent = this.dataset.comment;
            
            const rect = this.getBoundingClientRect();
            popup.style.top = `${rect.bottom + window.scrollY + 5}px`;
            popup.style.left = `${rect.left}px`;
            
            document.body.appendChild(popup);
            currentPopup = popup;
        });
    });

    // Toggle Comments
    const toggleButton = document.getElementById('toggleComments');
    let showAllComments = false;
    
    toggleButton.addEventListener('click', function(e) {
        e.preventDefault();
        showAllComments = !showAllComments;
        
        document.querySelectorAll('.full-comment').forEach(span => {
            span.style.display = showAllComments ? 'inline' : 'none';
        });
        
        document.querySelectorAll('.comment-link').forEach(link => {
            link.style.display = showAllComments ? 'none' : 'inline';
        });
        
        this.textContent = showAllComments ? 'Hide Comments' : 'Show All Comments';
    });

    // Close Popups
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.auto-path-link, .comment-link') && 
            !e.target.closest('.auto-path-popup, .comment-popup')) {
            closePopups();
        }
    });

    function closePopups() {
        if (currentPopup) {
            currentPopup.remove();
            currentPopup = null;
        }
    }
});
</script>

{% endblock %}